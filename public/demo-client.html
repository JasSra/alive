<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cross-Origin Event Tracking Demo</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 40px; 
            line-height: 1.6; 
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
        }
        .demo-section { 
            margin: 20px 0; 
            padding: 20px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
        }
        .success { 
            color: green; 
            font-weight: bold; 
        }
        .error { 
            color: red; 
            font-weight: bold; 
        }
        .info { 
            color: blue; 
        }
        button { 
            padding: 10px 20px; 
            margin: 10px 5px; 
            cursor: pointer; 
            border: none; 
            border-radius: 4px; 
            background: #007bff; 
            color: white; 
        }
        button:hover { 
            background: #0056b3; 
        }
        #log { 
            margin-top: 20px; 
            padding: 15px; 
            background: #f8f9fa; 
            border-radius: 4px; 
            height: 300px; 
            overflow-y: auto; 
            font-family: 'Courier New', monospace; 
            font-size: 12px; 
        }
        .status { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px; 
        }
        .status.connected { 
            background: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb; 
        }
        .status.disconnected { 
            background: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb; 
        }
        .suggestion {
            margin: 10px 0;
            padding: 10px;
            background: #e7f3ff;
            border-left: 4px solid #007bff;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Cross-Origin Event Tracking Demo</h1>
        
        <div class="status" id="connectionStatus">
            üîÑ Checking connection to event tracking server...
        </div>

        <p><strong>Current URL:</strong> <span id="currentUrl"></span></p>
        <p><strong>Target API:</strong> <span id="targetApi">http://localhost:3001</span></p>
        
        <div class="demo-section">
            <h2>üìä Basic Event Tracking</h2>
            <p>Test basic event tracking functionality:</p>
            
            <button onclick="trackPageView()">Track Page View</button>
            <button onclick="trackUserAction()">Track User Action</button>
            <button onclick="trackCustomEvent()">Track Custom Event</button>
        </div>

        <div class="demo-section">
            <h2>üéØ Advanced Event Tracking</h2>
            <p>Test advanced tracking features:</p>
            
            <button onclick="trackApiCall()">Track API Call</button>
            <button onclick="trackError()">Track Error</button>
            <button onclick="trackBatchEvents()">Track Batch Events</button>
        </div>

        <div class="demo-section">
            <h2>ü§ñ AI Suggestions</h2>
            <p>Events may trigger AI suggestions. They will appear here:</p>
            <div id="suggestions"></div>
        </div>

        <div class="demo-section">
            <h2>üìã Event Log</h2>
            <button onclick="clearLog()">Clear Log</button>
            <div id="log"></div>
        </div>
    </div>

    <!-- Load the event tracker client -->
    <script src="/event-tracker-client.js"></script>
    
    <script>
        // Initialize tracker for cross-origin testing
        let tracker;
        
        // Initialize the page
        function initializePage() {
            document.getElementById('currentUrl').textContent = window.location.href;
            
            // Initialize tracker with explicit target
            tracker = new EventTracker('http://localhost:3001', 'demo-app');
            
            // Override the test connection method to update UI
            const originalTestConnection = tracker.testConnection;
            tracker.testConnection = async function() {
                try {
                    const response = await fetch(`${this.baseUrl}/api/events?limit=1`, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        updateConnectionStatus(true, 'Connected to event tracking server');
                        log('‚úÖ Event tracker connected successfully', 'success');
                    } else {
                        updateConnectionStatus(false, `Connection issue: ${response.status}`);
                        log(`‚ö†Ô∏è Connection issue: ${response.status}`, 'error');
                    }
                } catch (error) {
                    updateConnectionStatus(false, 'Connection failed: ' + error.message);
                    log(`‚ùå Connection failed: ${error.message}`, 'error');
                }
            };
            
            tracker.testConnection();
        }

        function updateConnectionStatus(connected, message) {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.className = `status ${connected ? 'connected' : 'disconnected'}`;
            statusEl.textContent = `${connected ? '‚úÖ' : '‚ùå'} ${message}`;
        }

        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logEl.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // Event tracking functions
        async function trackPageView() {
            log('üîÑ Tracking page view...', 'info');
            const result = await tracker.trackPageView();
            if (result.success) {
                log('‚úÖ Page view tracked successfully', 'success');
            } else {
                log(`‚ùå Page view tracking failed: ${result.error}`, 'error');
            }
        }

        async function trackUserAction() {
            log('üîÑ Tracking user action...', 'info');
            const result = await tracker.trackUserAction('button-click', { 
                button: 'track-user-action',
                section: 'demo'
            });
            if (result.success) {
                log('‚úÖ User action tracked successfully', 'success');
            } else {
                log(`‚ùå User action tracking failed: ${result.error}`, 'error');
            }
        }

        async function trackCustomEvent() {
            log('üîÑ Tracking custom event...', 'info');
            const result = await tracker.track('demo-custom-event', {
                metadata: {
                    feature: 'cross-origin-demo',
                    timestamp: Date.now(),
                    userInteraction: true
                }
            });
            if (result.success) {
                log('‚úÖ Custom event tracked successfully', 'success');
            } else {
                log(`‚ùå Custom event tracking failed: ${result.error}`, 'error');
            }
        }

        async function trackApiCall() {
            log('üîÑ Tracking simulated API call...', 'info');
            const start = Date.now();
            
            // Simulate API call
            await new Promise(resolve => setTimeout(resolve, Math.random() * 500 + 100));
            const duration = Date.now() - start;
            
            const result = await tracker.trackApiCall('/api/demo/test', 'GET', 200, duration);
            if (result.success) {
                log(`‚úÖ API call tracked (${duration}ms)`, 'success');
            } else {
                log(`‚ùå API call tracking failed: ${result.error}`, 'error');
            }
        }

        async function trackError() {
            log('üîÑ Tracking simulated error...', 'info');
            const simulatedError = new Error('This is a demo error for testing purposes');
            
            const result = await tracker.trackError(simulatedError, {
                component: 'demo-page',
                action: 'test-error-tracking'
            });
            if (result.success) {
                log('‚úÖ Error tracked successfully', 'success');
            } else {
                log(`‚ùå Error tracking failed: ${result.error}`, 'error');
            }
        }

        async function trackBatchEvents() {
            log('üîÑ Tracking batch of events...', 'info');
            
            const events = [
                {
                    eventName: 'batch-event-1',
                    payload: { metadata: { type: 'batch', index: 1 } }
                },
                {
                    eventName: 'batch-event-2',
                    payload: { metadata: { type: 'batch', index: 2 } }
                },
                {
                    eventName: 'batch-event-3',
                    payload: { metadata: { type: 'batch', index: 3 } }
                }
            ];
            
            const result = await tracker.trackBatch(events);
            if (result.success) {
                log(`‚úÖ Batch of ${events.length} events tracked successfully`, 'success');
            } else {
                log(`‚ùå Batch tracking failed: ${result.error}`, 'error');
            }
        }

        // Listen for AI suggestions
        window.addEventListener('aiSuggestions', (event) => {
            const suggestions = event.detail.suggestions;
            log(`ü§ñ Received ${suggestions.length} AI suggestions`, 'info');
            
            const suggestionsEl = document.getElementById('suggestions');
            suggestions.forEach(suggestion => {
                const suggestionEl = document.createElement('div');
                suggestionEl.className = 'suggestion';
                suggestionEl.innerHTML = `
                    <strong>${suggestion.title}</strong>
                    ${suggestion.description ? `<br><small>${suggestion.description}</small>` : ''}
                    ${suggestion.score ? `<br><small>Confidence: ${(suggestion.score * 100).toFixed(1)}%</small>` : ''}
                `;
                suggestionsEl.appendChild(suggestionEl);
            });
        });

        // Initialize when page loads
        window.addEventListener('load', initializePage);
    </script>
</body>
</html>

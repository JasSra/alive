<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Monitor Test</title>
    <style>
        body {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            margin: 0;
            padding: 20px;
            background: #1a1a1a;
            color: #00ff00;
            font-size: 14px;
            line-height: 1.4;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1, h2, h3 {
            color: #00ff41;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }
        .section {
            margin: 30px 0;
            padding: 20px;
            background: #222;
            border: 1px solid #444;
            border-radius: 8px;
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 12px;
        }
        .status.success { background: #0f5132; color: #d1e7dd; }
        .status.error { background: #842029; color: #f8d7da; }
        .status.pending { background: #664d03; color: #fff3cd; }
        
        button {
            background: #333;
            color: #00ff00;
            border: 1px solid #666;
            padding: 8px 16px;
            cursor: pointer;
            border-radius: 4px;
            margin: 5px;
            font-family: inherit;
        }
        button:hover {
            background: #444;
            border-color: #00ff00;
        }
        
        .log {
            background: #111;
            border: 1px solid #333;
            padding: 15px;
            border-radius: 4px;
            height: 300px;
            overflow-y: auto;
            font-size: 12px;
            white-space: pre-wrap;
            margin-top: 10px;
        }
        
        .event-line {
            margin: 2px 0;
            padding: 2px 0;
        }
        .event-line.network { color: #00ff00; }
        .event-line.dom { color: #ffff00; }
        .event-line.console { color: #ff6600; }
        .event-line.error { color: #ff0000; }
        .event-line.server { color: #00ffff; }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        
        .info-card {
            background: #333;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #555;
        }
        
        .info-card h4 {
            margin: 0 0 10px 0;
            color: #00ff41;
            font-size: 14px;
        }
        
        .info-card p {
            margin: 5px 0;
            font-size: 12px;
        }
        
        input[type="text"] {
            background: #333;
            color: #00ff00;
            border: 1px solid #666;
            padding: 6px 10px;
            border-radius: 4px;
            font-family: inherit;
            width: 200px;
            margin: 5px;
        }
        
        .timestamp {
            color: #888;
            font-size: 11px;
        }
        
        .json-output {
            background: #0a0a0a;
            border: 1px solid #444;
            padding: 10px;
            border-radius: 4px;
            color: #ccc;
            font-size: 11px;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .pulse {
            animation: pulse 1s ease-in-out infinite alternate;
        }
        
        @keyframes pulse {
            from { opacity: 0.6; }
            to { opacity: 1; }
        }
        
        .monitor-info {
            background: #2a4a2a;
            border: 1px solid #4a6a4a;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåê Live Network Monitor Test Suite</h1>
        
        <div class="monitor-info">
            <strong>Monitor Status:</strong> <span id="monitorStatus" class="status pending">Loading...</span>
            <br><strong>Server URL:</strong> http://localhost:3001
            <br><strong>Events Captured:</strong> <span id="eventCount">0</span>
            <br><strong>Current Time:</strong> <span id="currentTime" class="timestamp">--</span>
        </div>

        <div class="grid">
            <div class="section">
                <h2>üîå Server Connectivity Tests</h2>
                <div class="controls">
                    <button onclick="testServerConnection()">Test Server</button>
                    <button onclick="testSSEConnection()">Test SSE Stream</button>
                    <button onclick="testCORS()">Test CORS</button>
                    <span id="connectivityStatus" class="status pending">Not tested</span>
                </div>
                
                <div class="info-grid">
                    <div class="info-card">
                        <h4>Server API</h4>
                        <p>Status: <span id="apiStatus">Pending</span></p>
                        <p>Response Time: <span id="apiTime">--</span></p>
                    </div>
                    <div class="info-card">
                        <h4>SSE Stream</h4>
                        <p>Status: <span id="sseStatus">Pending</span></p>
                        <p>Events Received: <span id="sseEventCount">0</span></p>
                    </div>
                    <div class="info-card">
                        <h4>CORS Policy</h4>
                        <p>Status: <span id="corsStatus">Pending</span></p>
                        <p>Cross-Origin: <span id="corsSupport">Unknown</span></p>
                    </div>
                </div>
                
                <div id="serverResults" class="json-output"></div>
            </div>

            <div class="section">
                <h2>üì° Network Request Demo</h2>
                <div class="controls">
                    <button onclick="sendTestEvent('user-login')">Send Login Event</button>
                    <button onclick="sendTestEvent('purchase')">Send Purchase Event</button>
                    <button onclick="sendTestEvent('cart-add')">Send Cart Event</button>
                    <input type="text" id="customEvent" placeholder="Custom event name" value="test-event">
                    <button onclick="sendCustomEvent()">Send Custom</button>
                </div>
                
                <p><strong>API Calls Made:</strong> <span id="apiCallCount">0</span></p>
                <div id="networkResults" class="json-output"></div>
            </div>
        </div>

        <div class="section">
            <h2>üéØ DOM Event Testing</h2>
            <div class="controls">
                <button onclick="triggerDOMEvents()">Trigger DOM Events</button>
                <button onclick="triggerFormEvents()">Form Events</button>
                <button onclick="triggerScrollEvent()">Scroll Event</button>
                <button onclick="triggerConsoleMessages()">Console Messages</button>
            </div>
            
            <div class="grid">
                <div>
                    <h4>Test Elements</h4>
                    <button id="testBtn1" onclick="console.log('Button 1 clicked')">Test Button 1</button>
                    <button id="testBtn2" onclick="console.log('Button 2 clicked')">Test Button 2</button>
                    <input type="text" id="testInput" placeholder="Type here..." onchange="console.log('Input changed:', this.value)">
                    <select id="testSelect" onchange="console.log('Select changed:', this.value)">
                        <option value="">Select option</option>
                        <option value="option1">Option 1</option>
                        <option value="option2">Option 2</option>
                    </select>
                </div>
                <div>
                    <h4>Event Statistics</h4>
                    <p>DOM Events: <span id="domEventCount">0</span></p>
                    <p>Console Messages: <span id="consoleEventCount">0</span></p>
                    <p>Network Requests: <span id="networkEventCount">0</span></p>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>üìã Live Event Monitor</h2>
            <div class="controls">
                <button onclick="clearEventLog()">Clear Log</button>
                <button onclick="exportEvents()">Export Events</button>
                <label>
                    <input type="checkbox" id="autoScroll" checked> Auto-scroll
                </label>
                <label>
                    Show: 
                    <select id="filterType" onchange="filterEvents()">
                        <option value="all">All Events</option>
                        <option value="network">Network Only</option>
                        <option value="dom">DOM Only</option>
                        <option value="console">Console Only</option>
                        <option value="server">Server Only</option>
                    </select>
                </label>
            </div>
            <div id="eventLog" class="log"></div>
        </div>

        <div class="section">
            <h2>‚öôÔ∏è Monitor Script Control</h2>
            <div class="controls">
                <button onclick="loadMonitorScript()">Load Monitor Script</button>
                <button onclick="unloadMonitorScript()">Unload Monitor</button>
                <span id="scriptStatus" class="status pending">Not loaded</span>
            </div>
            
            <div class="info-grid">
                <div class="info-card">
                    <h4>Script Info</h4>
                    <p>Version: <span id="scriptVersion">--</span></p>
                    <p>Time Window: <span id="timeWindow">--</span></p>
                </div>
                <div class="info-card">
                    <h4>Monitoring Status</h4>
                    <p>Active: <span id="monitoringActive">--</span></p>
                    <p>Events/min: <span id="eventRate">--</span></p>
                </div>
                <div class="info-card">
                    <h4>Browser Console</h4>
                    <p>Load the monitor script in any website's console:</p>
                    <div class="json-output" style="margin-top: 5px; font-size: 10px; height: auto;">
(function() {
  const script = document.createElement('script');
  script.src = 'http://localhost:3001/monitor.js';
  script.onload = () => console.log('‚úÖ Monitor loaded!');
  script.onerror = () => console.error('‚ùå Failed to load');
  document.head.appendChild(script);
})();
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let eventCount = 0;
        let apiCallCount = 0;
        let domEventCount = 0;
        let consoleEventCount = 0;
        let networkEventCount = 0;
        let sseEventCount = 0;
        let eventSource = null;
        let eventHistory = [];
        let monitorScript = null;

        // Server configuration
        const SERVER_URL = 'http://localhost:3001';
        const API_BASE = `${SERVER_URL}/api/events`;

        // Update current time
        function updateCurrentTime() {
            document.getElementById('currentTime').textContent = new Date().toLocaleTimeString();
        }
        setInterval(updateCurrentTime, 1000);
        updateCurrentTime();

        // Log event to the monitor
        function logEvent(type, message, data = null) {
            eventCount++;
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('eventLog');
            
            const eventLine = document.createElement('div');
            eventLine.className = `event-line ${type}`;
            
            let logMessage = `[${timestamp}] [${type.toUpperCase()}] ${message}`;
            if (data) {
                logMessage += `\n    ${JSON.stringify(data, null, 2)}`;
            }
            
            eventLine.textContent = logMessage;
            logElement.appendChild(eventLine);
            
            // Auto-scroll if enabled
            if (document.getElementById('autoScroll').checked) {
                logElement.scrollTop = logElement.scrollHeight;
            }
            
            // Update counters
            document.getElementById('eventCount').textContent = eventCount;
            if (type === 'dom') domEventCount++;
            else if (type === 'console') consoleEventCount++;
            else if (type === 'network') networkEventCount++;
            else if (type === 'server') sseEventCount++;
            
            updateEventCounters();
            
            // Store in history
            eventHistory.push({
                timestamp: new Date().toISOString(),
                type,
                message,
                data
            });
        }

        function updateEventCounters() {
            document.getElementById('domEventCount').textContent = domEventCount;
            document.getElementById('consoleEventCount').textContent = consoleEventCount;
            document.getElementById('networkEventCount').textContent = networkEventCount;
            document.getElementById('sseEventCount').textContent = sseEventCount;
        }

        // Server connectivity tests
        async function testServerConnection() {
            const startTime = Date.now();
            try {
                const response = await fetch(`${API_BASE}/statistics?from=${new Date(Date.now() - 5 * 60 * 1000).toISOString()}&to=${new Date().toISOString()}&userScope=all`);
                const responseTime = Date.now() - startTime;
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('apiStatus').textContent = 'Connected ‚úÖ';
                    document.getElementById('apiTime').textContent = `${responseTime}ms`;
                    document.getElementById('connectivityStatus').className = 'status success';
                    document.getElementById('connectivityStatus').textContent = 'Server Online';
                    
                    logEvent('server', 'Server connection test successful', { responseTime, dataReceived: !!data });
                    document.getElementById('serverResults').textContent = JSON.stringify(data, null, 2);
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                document.getElementById('apiStatus').textContent = 'Failed ‚ùå';
                document.getElementById('connectivityStatus').className = 'status error';
                document.getElementById('connectivityStatus').textContent = 'Server Offline';
                
                logEvent('error', 'Server connection failed', { error: error.message });
                document.getElementById('serverResults').textContent = `Error: ${error.message}`;
            }
        }

        function testSSEConnection() {
            if (eventSource) {
                eventSource.close();
            }
            
            document.getElementById('sseStatus').textContent = 'Connecting...';
            
            eventSource = new EventSource(`${API_BASE}/stream`);
            
            eventSource.onopen = () => {
                document.getElementById('sseStatus').textContent = 'Connected ‚úÖ';
                logEvent('server', 'SSE connection established');
            };
            
            eventSource.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    logEvent('server', 'SSE event received', data);
                } catch (e) {
                    logEvent('server', 'SSE event received (raw)', { data: event.data });
                }
            };
            
            eventSource.onerror = (error) => {
                document.getElementById('sseStatus').textContent = 'Failed ‚ùå';
                logEvent('error', 'SSE connection error', error);
            };
        }

        async function testCORS() {
            try {
                const response = await fetch(`${API_BASE}/statistics?from=${new Date().toISOString()}&to=${new Date().toISOString()}&userScope=all`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                document.getElementById('corsStatus').textContent = 'Enabled ‚úÖ';
                document.getElementById('corsSupport').textContent = 'Supported';
                logEvent('server', 'CORS test successful');
            } catch (error) {
                document.getElementById('corsStatus').textContent = 'Failed ‚ùå';
                document.getElementById('corsSupport').textContent = 'Blocked';
                logEvent('error', 'CORS test failed', { error: error.message });
            }
        }

        // Network request demo
        async function sendTestEvent(eventName) {
            apiCallCount++;
            networkEventCount++;
            
            const payload = {
                userAgent: 'test-monitor',
                metadata: {
                    testId: Math.random().toString(36).substr(2, 9),
                    source: 'test-monitor-page',
                    timestamp: Date.now()
                },
                correlationId: `test-${Date.now()}`,
                statusCode: 200,
                responseTimeMs: Math.floor(Math.random() * 100) + 50
            };

            try {
                const response = await fetch(`${API_BASE}/track/${eventName}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    const result = await response.json();
                    logEvent('network', `Sent ${eventName} event`, result);
                    document.getElementById('networkResults').textContent = JSON.stringify(result, null, 2);
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                logEvent('error', `Failed to send ${eventName} event`, { error: error.message });
            }
            
            document.getElementById('apiCallCount').textContent = apiCallCount;
        }

        function sendCustomEvent() {
            const eventName = document.getElementById('customEvent').value || 'test-event';
            sendTestEvent(eventName);
        }

        // DOM event testing
        function triggerDOMEvents() {
            // Simulate various DOM events
            const events = ['click', 'mouseover', 'mouseout', 'focus', 'blur'];
            events.forEach((eventType, index) => {
                setTimeout(() => {
                    const event = new Event(eventType, { bubbles: true });
                    document.body.dispatchEvent(event);
                    logEvent('dom', `Triggered ${eventType} event`);
                }, index * 100);
            });
        }

        function triggerFormEvents() {
            const input = document.getElementById('testInput');
            const select = document.getElementById('testSelect');
            
            input.value = `Test value ${Date.now()}`;
            input.dispatchEvent(new Event('change', { bubbles: true }));
            
            select.value = 'option1';
            select.dispatchEvent(new Event('change', { bubbles: true }));
            
            logEvent('dom', 'Form events triggered');
        }

        function triggerScrollEvent() {
            window.scrollBy(0, 100);
            setTimeout(() => window.scrollBy(0, -100), 500);
            logEvent('dom', 'Scroll event triggered');
        }

        function triggerConsoleMessages() {
            console.log('Test console log message');
            console.warn('Test console warning');
            console.error('Test console error');
            console.info('Test console info');
            logEvent('console', 'Console messages triggered');
        }

        // Event log management
        function clearEventLog() {
            document.getElementById('eventLog').innerHTML = '';
            eventHistory = [];
            eventCount = 0;
            domEventCount = 0;
            consoleEventCount = 0;
            networkEventCount = 0;
            sseEventCount = 0;
            updateEventCounters();
            document.getElementById('eventCount').textContent = '0';
        }

        function exportEvents() {
            const dataStr = JSON.stringify(eventHistory, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `monitor-events-${Date.now()}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            logEvent('dom', 'Events exported');
        }

        function filterEvents() {
            const filterType = document.getElementById('filterType').value;
            const eventLines = document.querySelectorAll('.event-line');
            
            eventLines.forEach(line => {
                if (filterType === 'all' || line.classList.contains(filterType)) {
                    line.style.display = 'block';
                } else {
                    line.style.display = 'none';
                }
            });
        }

        // Monitor script management
        function loadMonitorScript() {
            if (monitorScript) {
                document.head.removeChild(monitorScript);
            }
            
            monitorScript = document.createElement('script');
            monitorScript.src = `${SERVER_URL}/monitor.js`;
            
            monitorScript.onload = () => {
                document.getElementById('scriptStatus').className = 'status success';
                document.getElementById('scriptStatus').textContent = 'Loaded ‚úÖ';
                document.getElementById('scriptVersion').textContent = 'v1.0';
                document.getElementById('timeWindow').textContent = 'T-5M';
                document.getElementById('monitoringActive').textContent = 'Yes';
                logEvent('dom', 'Monitor script loaded successfully');
            };
            
            monitorScript.onerror = () => {
                document.getElementById('scriptStatus').className = 'status error';
                document.getElementById('scriptStatus').textContent = 'Failed ‚ùå';
                logEvent('error', 'Failed to load monitor script');
            };
            
            document.head.appendChild(monitorScript);
        }

        function unloadMonitorScript() {
            if (monitorScript) {
                document.head.removeChild(monitorScript);
                monitorScript = null;
                document.getElementById('scriptStatus').className = 'status pending';
                document.getElementById('scriptStatus').textContent = 'Not loaded';
                document.getElementById('scriptVersion').textContent = '--';
                document.getElementById('timeWindow').textContent = '--';
                document.getElementById('monitoringActive').textContent = '--';
                logEvent('dom', 'Monitor script unloaded');
            }
        }

        // Initialize page
        function initializePage() {
            document.getElementById('monitorStatus').className = 'status success';
            document.getElementById('monitorStatus').textContent = 'Ready ‚úÖ';
            
            logEvent('dom', 'Test monitor page initialized');
            
            // Auto-test server connection
            setTimeout(testServerConnection, 1000);
            setTimeout(testSSEConnection, 2000);
        }

        // Start when page loads
        window.addEventListener('load', initializePage);

        // Override console methods to capture messages
        const originalConsole = {
            log: console.log,
            warn: console.warn,
            error: console.error,
            info: console.info
        };

        ['log', 'warn', 'error', 'info'].forEach(method => {
            console[method] = function(...args) {
                originalConsole[method].apply(console, args);
                logEvent('console', `Console ${method}`, { args: args.map(arg => 
                    typeof arg === 'object' ? JSON.stringify(arg) : String(arg)
                )});
            };
        });

        // Capture network requests
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            const url = args[0];
            const options = args[1] || {};
            
            logEvent('network', 'Fetch request initiated', { url, method: options.method || 'GET' });
            
            return originalFetch.apply(this, args).then(response => {
                logEvent('network', 'Fetch response received', { 
                    url, 
                    status: response.status, 
                    ok: response.ok 
                });
                return response;
            }).catch(error => {
                logEvent('error', 'Fetch request failed', { url, error: error.message });
                throw error;
            });
        };
    </script>
</body>
</html>
